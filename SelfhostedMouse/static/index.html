<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Selfhosted Mouse</title>
        <style type="text/css">
            html, body {
                overflow: hidden;
                -webkit-overflow-scrolling: revert;
            }
            body {
                font-family: "Courier New", sans-serif;
                text-align: center;
                background: #656565;
            }
            .console {
                position: absolute;
                top: 0;
                bottom: 80%;
                left: 0;
                right: 0;
                overflow-x: scroll;
            }
            .buttons, .settings {
                font-size: 4em;
                display: flex;
                justify-content: center;
                position: absolute;
                bottom: 0;
            }
            .settings {
                justify-content: left;
                height: 0;
                opacity: 0.0;
                display: none;
                background-color: rgba(6, 6, 6, 0.9);
                position: absolute;
                color: white;
                left: 0;
                right: 0;
                bottom: 0;
            }
            .settings.show {
                opacity: 1.0;
                display: block;
                height: 100%;
            }
            .settings .upper {
                overflow-x: auto;
                padding-top: 1em;
                padding-bottom: 1em;
            }
            .settings .upper label {
                margin-top: 1em;
            }
            .button, .value {
                line-height: 1;
                padding: 2rem;
                margin: 2rem;
                border: medium solid;
                min-height: 1em;
                min-width: 1em;
            }
            .button {
                cursor: pointer;
                user-select: none;
            }
            .settings .button.close {
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
            }
            .trackpad {
                /*top: 20%; /* console */
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                position: absolute;
                //background: #656565;
                overflow: scroll;
                line-break: auto;
            }
        </style>
        <meta charset="utf-8" />
        <meta name="apple-mobile-web-app-title" content="shMouse" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <script>
            if(true) {  // weinre debug
                var scpt = document.createElement('script');
                scpt.type = 'text/javascript';
                scpt.src = 'http://'+location.hostname+':8081/target/target-script-min.js#mouse';
                //document.querySelector('head').appendChild(scpt);
            }
        </script>
        <link href="/console/stylesheet.css" rel="stylesheet" type="text/css" />
        <script src="/prettyprint.js"></script>
        <script src="/console/javascript.js"></script>
    </head>
    <body>
        <div class="trackpad"></div>
        <div class="console"></div>
        <div class="buttons">
            <div class="setting button">settings</div>
            <div class="paste button" contenteditable="true">paste here</div>
        </div>
        <div class="settings">
            <div class="close button">close</div>
            <div class="upper">
                <label>Native scrolling</label>
                <div class="scroll button" id="scroll">up</div>

                <label>Screen orientation</label>
                <div class="orientation button">0°</div>

                <label>Reload the page</label>
                <div class="reload button" id="reload" onclick="location.reload()">reload</div>
            </div>
        </div>
        <!--<div class="state">
            <span class="users">?</span> online
        </div>
        -->
        <script>
            /*
            websocket.onmessage = function (event) {
                data = JSON.parse(event.data);
                switch (data.type) {
                    case 'state':
                        value.textContent = data.value;
                        break;
                    case 'users':
                        users.textContent = (
                            data.count.toString() + " user" +
                            (data.count == 1 ? "" : "s"));
                        break;
                    default:
                        console.error("unsupported event", data);
                }
            };
            */
            function base64file(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                }
            )}

            function Settings(mouse) {
                this.mouse = mouse;

                this.pane = document.querySelector('.settings');
                this.open = document.querySelector('.setting');
                this.close = document.querySelector('.settings .close');
                this.scroll = document.querySelector('.settings .scroll');
                this.orientation = document.querySelector('.settings .orientation');
            }
            Settings.prototype = {
                bind: function () {
                    this.open.onclick = this.toggle_show.bind(this);
                    this.close.onclick = this.toggle_show.bind(this);
                    this.scroll.onclick = this.toggle_scroll.bind(this);
                    this.orientation.onclick = this.toggle_orientation.bind(this);
                    // load settings
                    this.update_scroll(this.storage_get('invert_scroll', true));
                    this.update_orientation(this.storage_get('orientation', true));
                },
                toggle_show(e) {
                    console.log('toggled');
                    if (this.pane.classList.contains('show')) {
                        this.pane.classList.remove('show');
                    } else {
                        this.pane.classList.add('show');
                    }
                },
                toggle_orientation: function (e) {
                    var orientation = ((this.mouse.orientation + 180) % 360)-90;  // cycles through -90, 0, 90, 180
                    this.update_orientation(orientation);
                },
                update_orientation(orientation) {
                    this.mouse.orientation = orientation;
                    this.orientation.innerText = orientation + '° ' + Emoji[orientation];
                    this.storage_save('orientation', orientation);
                },
                toggle_scroll: function (e) {
                    this.update_scroll(!this.mouse.invert_scroll);
                },
                update_scroll(invert) {
                    this.mouse.invert_scroll = invert;
                    this.scroll.innerText = invert ? 'down' : 'up';
                    this.storage_save('invert_scroll', invert);
                }
            };

            Settings.prototype.storage_check = function() {
                return typeof(Storage) !== "undefined";
            };

            Settings.prototype.storage_save = function(key, value, days) {
                value = JSON.stringify(value);
                if (this.storage_check()) {
                    localStorage.setItem(key, value);
                } else {
                    // cookie fallback
                    var expires = "";
                    if (days) {
                        var date = new Date();
                        date.setTime(date.getTime()+(days*24*60*60*1000));
                        expires = "; expires=" + date.toGMTString();
                    }
                    document.cookie = key+"="+value+expires+"; path=/";
                }
            };

            Settings.prototype.storage_get = function(key, default_value=undefined) {
                var value = null;
                if (this.storage_check()) {
                    value = localStorage.getItem(key);
                    if (value === null) {
                        return default_value;
                    }
                } else {
                    // cookie fallback
                    /*
                     * after adding a cookie like
                     * >> document.cookie = "bar=test; expires=Thu, 14 Jun 2018 13:05:38 GMT; path=/"
                     * the content of document.cookie may look like
                     * >> "foo=value; bar=test"
                     */
                    var nameEQ = name + "=";  // what we are looking for
                    var ca = document.cookie.split(';');  // split into separate cookies
                    for(var i=0;i < ca.length;i++) {
                        var c = ca[i];  // the current cookie
                        while (c.charAt(0) === ' ') c = c.substring(1,c.length);  // remove leading spaces
                        if (c.indexOf(nameEQ) === 0) {  // if it is the searched cookie
                            value = c.substring(nameEQ.length,c.length);
                            break;
                        }
                    }
                    return default_value; // no cookie found
                }
                return JSON.parse(value);
            };

            function Mouse() {
                this.body = document.querySelector('body');
                this.trackpad = document.querySelector('.trackpad');
                this.paste = document.querySelector('.paste');
                this.paste_last_html = this.paste.innerHTML;
                //this.users = document.querySelector('.users');
                this.url = "ws://"+location.host+"/s";
                this.websocket = new WebSocket(this.url);
                this.websocket.addEventListener('open', function (e) {
                     console.log('websocket opened', e);
                });
                this.websocket.addEventListener('message', function (e) {
                     console.log('websocket message', e);
                });
                this.websocket.addEventListener('error', function (e) {
                     console.error('websocket error', e);
                });
                this.websocket.addEventListener('close', function (e) {
                     console.log('websocket closed', e);
                });
                this.start_points = [];
                this.last_time = null;
                this.last_points = [];
                this.did_move = false;
                this.invert_scroll = false;
                this.orientation = 0;  // clockwise, in degree°. -90, 0, 90, 180
            }
            var Emoji = {};
            Emoji[-90] = "⬅️";
            Emoji[0] = "⬇️";
            Emoji[90] = "➡️";
            Emoji[180] = "⬆️";
            Mouse.prototype = {
                bind: function () {
                    // bind events
                    this.trackpad.ontouchstart = this.touchstart.bind(this);
                    this.trackpad.ontouchmove = this.touchmove.bind(this);
                    this.trackpad.ontouchend = this.touchend.bind(this);
                    this.trackpad.ontouchcancel = this.touchcancel.bind(this);
                    this.paste.onfocus = function () {window.setTimeout(this.select_all.bind(this), 1);}.bind(this);
                    this.paste.onblur = this.paste_blur.bind(this);
                    this.paste.addEventListener("paste", this.send_clipboard.bind(this), false);
                    this.paste.addEventListener('keydown', this.paste_on_keydown.bind(this), false);
                },
                event2pos: function (event) {
                    if (event === undefined || event === null) {
                        return [];
                    }
                    if (event.touches === undefined || event.touches === null) {
                        return [];
                    }
                    var touch_list = [];
                    for (var i = 0; i < event.touches.length; i++) {
                        var t = event.touches[i];
                        touch_list.push({x: t.clientX, y: t.clientY});
                    }
                    return touch_list;
                },
                distanceBetweenTwoPoints: function(x0, x1, y0, y1) {
                    let dist = (Math.sqrt(((x1 - x0) * (x1 - x0)) + ((y1 - y0) * (y1 - y0))));
                    return Math.round(dist * 100) / 100;
                },
                getVelocity: function(startX, startY, startTime, endX, endY, endTime) {
                    let distance = this.distanceBetweenTwoPoints(startX, endX, startY, endY);
                    let velocity = (distance / (endTime - startTime));
                },
                get_movement: function(startX) {},
                posArr2txt: function (arr) {
                    if (arr === undefined || arr === null || arr === [] || !arr || arr.length === 0) {
                        return "";
                    }
                    return arr.map(itm => itm.x + " | " + itm.y).reduce((old, next) =>  old + "\n" + next);
                },
                touchstart: function (event) {
                    this.body.style.backgroundColor = 'green';
                    this.start_points = this.event2pos(event);
                    this.last_points = this.start_points;
                    this.did_move = false;
                    event.preventDefault();
                    return false;
                },
                pointCenter: function(points) {
                    var x = 0.0,
                        y = 0.0;
                    for (var i = 0; i < points.length; i++) {
                        x += points[i].x;
                        y += points[i].y;
                    }
                    return {x: x/i, y: y/i};
                },
                _rotate: function (x, y) {
                    var tmp = 0;
                    switch (this.orientation) {
                        case 0:
                            break;
                        case 90:
                            tmp = x;
                            x = y * -1;
                            y = tmp;
                            break;
                        case -90:
                            tmp = x * -1;
                            x = y * 1; // *1 to remove IDE's warning.
                            y = tmp;
                            break;
                        case 180:
                            x *= -1;
                            y *= -1;
                            break;
                    }
                    return {x:x, y:y};
                }, touchmove: function (event) {
                    var new_positions = this.event2pos(event),
                        new_time = new Date().getTime(),
                        new_pos, old_pos, x, y,
                        velocity_x, velocity_y;
                    if (new_positions.length === 1 || this.last_points.length === 1) {  // simple drag -> mouse move
                        this.body.style.backgroundColor = '#94ff00';
                        new_pos = new_positions[0];
                        old_pos = this.last_points[0];
                        x = new_pos.x - old_pos.x;
                        y = new_pos.y - old_pos.y;
                        var r = this._rotate(x, y);
                        this.websocket.send(JSON.stringify({action: 'move', x: r.x, y: r.y}));
                    } else if (new_positions.length === 2 && this.last_points.length === 2) {  // two finger drag -> mouse move
                        this.body.style.backgroundColor = 'orange';
                        new_pos = this.pointCenter(new_positions);
                        old_pos = this.pointCenter(this.last_points);
                        x = new_pos.x - old_pos.x;
                        y = new_pos.y - old_pos.y;
                        x = parseInt(x/10);
                        y = parseInt(y/10);
                        var r = this._rotate(x, y);
                        if (this.invert_scroll) {
                            r.y *= -1;
                        }
                        this.send({action: 'scroll', x: r.x, y: r.y});
                    }


                    this.did_move = true;
                    this.last_time = new_time;
                    this.last_points = new_positions;
                    event.preventDefault();
                    return false;
                },
                touchend: function (event) {
                    this.body.style.backgroundColor = '#656565';
                    //this.start_points = this.event2pos(event);
                    var new_pos = this.event2pos(event);
                    if (this.did_move === false) {
                        // end of click
                        var fingers = this.start_points.length;
                        this.send({action: 'click', button: fingers});
                    } else {
                        // end of drag
                    }
                    event.preventDefault();
                    return false;
                },
                touchcancel: function (event) {
                    this.body.style.backgroundColor = 'red';
                    //this.start_points = this.event2pos(event);
                    var new_pos = this.event2pos(event);
                    event.preventDefault();
                    return false;
                },
                onClipboardUpdate: function() {
                    navigator.paste.writeText(text).then(function () {
                        alert('updated clipboard from computer.');
                    }, function (err) {
                        alert('failed updating clipboard: '+err);
                    });
                },
                send: function (data) {
                    data = JSON.stringify(data);
                    //alert('send\n'+data);
                    console.log('send\t '+data);
                    this.websocket.send(data);
                },
                send_clipboard: function (e) {
                    var types = e.clipboardData.types;
                    var response = {};
                    var had_file = false;
                    for (var i = 0; i < types.length; i++) {
                        let type = types[i];
                        if (type === 'Files') {
                            had_file = true;
                            continue;
                        }
                        response[type] = e.clipboardData.getData(type);
                    }
                    if (had_file) {
                        e.clipboardData.files;
                        var file = null;
                        if (e.clipboardData.files.length) {
                            _files = e.clipboardData.files;
                            file = e.clipboardData.files[0];
                        } else if (e.clipboardData.items.length) {
                            _files = e.clipboardData.items;
                            file = e.clipboardData.items[0].getAsFile()
                        }
                        let p = base64file(file);

                        //alert(e.type + "\n"+ JSON.stringify(file));
                        p.then(function (data) {
                            // submit to server
                            let d_ata = {
                                action: 'paste', file: {
                                    data: data, type: file.type, name: file.name
                                }, text: response
                            };
                            this.send(d_ata);
                            //alert(e.type + "\n"+ JSON.stringify(d_ata));
                            // reset clipboard
                            this.paste.innerText="paste here";
                            window.setTimeout(function () {
                                window.window.getSelection().removeAllRanges();
                                this.paste_last_html = this.paste.innerHTML;
                                this.paste.blur();
                            }.bind(this), 2);
                        }.bind(this));
                    } else {
                        this.send({action: 'paste', text: response});
                        window.setTimeout(function () {
                            window.window.getSelection().removeAllRanges();
                            this.paste_last_html = this.paste.innerHTML;
                            this.paste.blur();
                        }.bind(this), 2);
                    }
                },
                select_all: function () {
                    var sel, range;
                    if (window.getSelection && document.createRange) {
                        range = document.createRange();
                        range.selectNodeContents(this.paste);
                        sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    } else if (document.body.createTextRange) {
                        range = document.body.createTextRange();
                        range.moveToElementText(this.paste);
                        range.select();
                    }
                },
                send_paste_field: function (override_dirty) {
                    this.send({
                        action: 'paste',
                        text: {
                            'text/html': this.paste.innerHTML,
                            'text/plain': this.paste.innerText,
                        }
                    });
                },
                paste_blur: function(e) {
                    if (this.paste_last_html !== this.paste.innerHTML) {
                        this.send_paste_field();
                        this.paste_last_html = this.paste.innerHTML;
                    }
                },
                paste_on_keydown: function(e) {
                    // trap the return key being pressed
                    if (e.keyCode === 13) {
                        if (e.metaKey === true) {
                            // submit clipboard
                            this.send_paste_field(true);
                            this.paste_last_html = this.paste.innerHTML;
                        } else {
                            // insert 2 br tags (if only one br tag is inserted the cursor won't go to the next line)
                            document.execCommand('insertHTML', false, '<br><br>');
                        }
                        // prevent the default behaviour of return key pressed
                        return false;
                    }
                },
            };
            var _files = null;
            var c = new HtmlConsole(document.querySelector('.console'));
            c.register();
            c.test();
            var m = new Mouse();
            var s = new Settings(m);
            m.bind();
            s.bind();

        </script>
    </body>
</html>