<!DOCTYPE html>
<html>
    <head>
        <title>Selfhosted Mouse</title>
        <style type="text/css">
            body {
                font-family: "Courier New", sans-serif;
                text-align: center;
            }
            .buttons {
                font-size: 4em;
                display: flex;
                justify-content: center;
                position: absolute;
                bottom: 0;
            }
            .button, .value {
                line-height: 1;
                padding: 2rem;
                margin: 2rem;
                border: medium solid;
                min-height: 1em;
                min-width: 1em;
            }
            .button {
                cursor: pointer;
                user-select: none;
            }
            .minus {
                color: red;
            }
            .plus {
                color: green;
            }
            .value {
                min-width: 2em;
            }
            .state {
                font-size: 2em;
            }
            .trackpad {
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                position: absolute;
                //background: #656565;
            }
            html, body {
                overflow: hidden;
                -webkit-overflow-scrolling: revert;
            }
            body {
                background: #656565;
            }
        </style>
        <meta name="apple-mobile-web-app-title" content="shMouse" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <script>
            if(true) {  // weinre debug
                var scpt = document.createElement('script');
                scpt.type = 'text/javaascript';
                scpt.src = 'http://'+location.hostname+':8081/target/target-script-min.js#mouse';
                document.getElementsByName('head')[0].appendChild(scpt);
            }
        </script>
        <script src="http://134.169.239.45:8081/target/target-script-min.js#mouse"></script>
    </head>
    <body>
        <div class="trackpad"></div>
        <div class="buttons">
            <div class="left button">+</div>
            <!--<div class="value">?</div>-->
            <div class="clipboard button" contenteditable="true">paste clipboard here</div>
        </div>
        <!--<div class="state">
            <span class="users">?</span> online
        </div>
        -->
        <script>
            /*document.ontouchmove = function (event) {
                event.preventDefault();
            }*/

            /*left.onclick = function (event) {
                websocket.send(JSON.stringify({action: 'minus'}));
            }
            right.onclick = function (event) {
                websocket.send(JSON.stringify({action: 'plus'}));
            }
            trackpad.ontouchmove = function (event) {
                trackpad.style.backgroundColor = 'red';
                event.preventDefault();
                return false;
            }
            trackpad.ontouchend = function (event) {
                trackpad.style.backgroundColor = 'gray';
                event.preventDefault();
                return false;
            }
            trackpad.ontouchmove = function (event) {
                var touch = event.touches[0];
                trackpad.innerText = touch.clientX + " x " + touch.clientY;
                event.preventDefault();
                return false;
            }
            websocket.onmessage = function (event) {
                data = JSON.parse(event.data);
                switch (data.type) {
                    case 'state':
                        value.textContent = data.value;
                        break;
                    case 'users':
                        users.textContent = (
                            data.count.toString() + " user" +
                            (data.count == 1 ? "" : "s"));
                        break;
                    default:
                        console.error("unsupported event", data);
                }
            };
            */
            function base64file(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                }
            )}


            function Mouse() {
                this.body = document.querySelector('body');
                this.trackpad = document.querySelector('.trackpad');
                this.left = document.querySelector('.left');
                this.clipboard = document.querySelector('.clipboard');
                //this.users = document.querySelector('.users');
                this.url = "ws://"+location.hostname+":6789/";
                this.websocket = new WebSocket(this.url);
                this.start_points = [];
                this.last_points = [];
                this.did_move = false;
            }
            Mouse.prototype = {
                init: function () {
                    //this.trackpad.addEventListener("touchstart", this.touchstart.bind(this), false);
                    //this.trackpad.addEventListener("touchmove", this.touchmove.bind(this), false);
                    this.trackpad.ontouchstart = this.touchstart.bind(this);
                    this.trackpad.ontouchmove = this.touchmove.bind(this);
                    this.trackpad.ontouchend = this.touchend.bind(this);
                    this.trackpad.ontouchcancel = this.touchcancel.bind(this);
                    //this.clipboard.onclick = function () {this.clipboard.focus();};
                    this.clipboard.onfocus = function () {window.setTimeout(this.select_all.bind(this), 1);}.bind(this);
                    this.clipboard.addEventListener("paste", this.send_clipboard.bind(this), false);
                    //document.addEventListener("copy",  clipboard, false);
        			//document.addEventListener("cut",   clipboard, false);
			        //document.addEventListener("paste", clipboard, false);

                },
                event2pos: function (event) {
                    if (event === undefined || event === null) {
                        return [];
                    }
                    if (event.touches === undefined || event.touches === null) {
                        return [];
                    }
                    var touch_list = [];
                    for (var i = 0; i < event.touches.length; i++) {
                        var t = event.touches[i];
                        touch_list.push({x: t.clientX, y: t.clientY});
                    }
                    return touch_list;
                },
                posArr2txt: function (arr) {
                    if (arr === undefined || arr === null || arr === [] || !arr || arr.length === 0) {
                        return "";
                    }
                    return arr.map(itm => itm.x + " | " + itm.y).reduce((old, next) =>  old + "\n" + next);
                },
                touchstart: function (event) {
                    this.body.style.backgroundColor = 'green';
                    this.start_points = this.event2pos(event);
                    this.last_points = this.start_points;
                    this.did_move = false;
                    this.trackpad.innerText = 'start: ' + this.posArr2txt(this.start_points);
                    event.preventDefault();
                    return false;
                },
                pointCenter: function(points) {
                    var x = 0.0,
                        y = 0.0;
                    for (var i = 0; i < points.length; i++) {
                        x += points[i].x;
                        y += points[i].y;
                    }
                    return {x: x/i, y: y/i};
                },
                touchmove: function (event) {
                    var new_positions = this.event2pos(event),
                        new_pos, old_pos, x, y;
                    if (new_positions.length === 1 || this.last_points.length === 1) {  // simple drag -> mouse move
                        this.body.style.backgroundColor = '#838383';
                        this.trackpad.innerText = 'Move: ' + this.posArr2txt(new_positions);
                        new_pos = new_positions[0];
                        old_pos = this.last_points[0];
                        x = new_pos.x - old_pos.x;
                        y = new_pos.y - old_pos.y;
                        this.websocket.send(JSON.stringify({action: 'move', x: x, y: y}));
                    } else if (new_positions.length === 2 && this.last_points.length === 2) {  // two finger drag -> mouse move
                        this.body.style.backgroundColor = 'orange';
                        new_pos = this.pointCenter(new_positions);
                        old_pos = this.pointCenter(this.last_points);
                        x = new_pos.x - old_pos.x;
                        y = new_pos.y - old_pos.y;
                        var lel = {action: 'scroll', x: parseInt(x/10), y: parseInt(y/10)};
                        this.trackpad.innerText = 'Scroll: ' + this.posArr2txt(new_positions);
                        this.send(lel);
                    }


                    this.did_move = true;
                    this.last_points = new_positions;
                    event.preventDefault();
                    return false;
                },
                touchend: function (event) {
                    this.body.style.backgroundColor = '#656565';
                    //this.start_points = this.event2pos(event);
                    var new_pos = this.event2pos(event);
                    this.trackpad.innerText = "\n\nEnded\n" + this.posArr2txt(new_pos);
                    if (this.did_move === false) {
                        // end of click
                        this.trackpad.innerText += "\n\nClick.";
                        var fingers = this.start_points.length;
                        this.send({action: 'click', button: fingers});
                    } else {
                        // end of drag
                        this.trackpad.innerText += "\n\nDrag.";
                    }
                    event.preventDefault();
                    return false;
                },
                touchcancel: function (event) {
                    this.body.style.backgroundColor = 'red';
                    //this.start_points = this.event2pos(event);
                    var new_pos = this.event2pos(event);
                    this.trackpad.innerText += "\n\nCanceled\n" + (this.posArr2txt(new_pos));
                    event.preventDefault();
                    return false;
                },
                onClipboardUpdate: function() {
                    navigator.clipboard.writeText(text).then(function () {
                        alert('updated clipboard from computer.');
                    }, function (err) {
                        alert('failed updating clipboard: '+err);
                    });
                },
                send: function (data) {
                    //alert('send\n'+data);
                    this.websocket.send(JSON.stringify(data));
                },
                send_clipboard: function (e) {
                    var types = e.clipboardData.types;
                    var response = {};
                    for (var i = 0; i < types.length; i++) {
                        let type = types[i];
                        if (type === 'Files') {
                            _files = e.clipboardData.files;
                            var f = _files[0];
                           var p = base64file(f);
                           p.then(function (data) {
                               this.send({
                                   action: 'copy', image: {
                                       data: data, type: f.type, name: f.name
                                   }
                               });
                               this.clipboard.innerText="paste here";
                               window.setTimeout(function () {
                                   window.window.getSelection().removeAllRanges();
                                   this.clipboard.blur();
                               }.bind(this), 2);

                           }.bind(this));
                           return;
                        }
                        response[type] = e.clipboardData.getData(type);
                    }
                    alert(e.type + "\n"+ JSON.stringify(response));
                    this.send({action: 'copy', text: response});
                    /*navigator.clipboard.readText().then(function (text) {
                        alert(JSON.stringify({action: 'copy', text: text}));
                        this.websocket.send(JSON.stringify({action: 'copy', text: text}));
                    }.bind(this), function (err) {
                        alert('failed: '+err);
                    });*/
                },
                select_all: function () {
                    var sel, range;
                    if (window.getSelection && document.createRange) {
                        range = document.createRange();
                        range.selectNodeContents(this.clipboard);
                        sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    } else if (document.body.createTextRange) {
                        range = document.body.createTextRange();
                        range.moveToElementText(this.clipboard);
                        range.select();
                    }
                }
            };
            var _files = null;
            var m = new Mouse();
            m.init();
        </script>
    </body>
</html>